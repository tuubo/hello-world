## 4.3 表示処理に伴う問題

### HTML エスケープ

- 通常要素：`<` と `&` を文字参照にする
- 属性値：属性値を `"` で囲み、`<` と `&` と `"` を文字参照にする

HTML エスケープが適切にできていない場合、攻撃者が好きな属性や HTML 要素をコード上に追加し XSS 攻撃を仕掛ける事を許してしまう可能性がある。

- `src` などの属性値(URL)に javascript スキームを渡すと、 JavaScript を起動できる。

#### 対策

`http:` または `https:` で始まる絶対 URL、`/` で始まる相対 URL のどちらかのみを許容するようにチェックする。

## 4.4 SQL 呼び出しに伴う脆弱性

### SQL インジェクション

- SQL の呼び出し方に不備がある場合に発生する
- DB の情報漏えい、DB の書き換え、認証回避等の影響の大きい攻撃になりうる
- 静的プレースホルダを用いて SQL を呼び出すことで、SQL インジェクションを回避できる

## 4.5 「重要な処理」の際に混入する脆弱性

### クロスサイト・リクエストフォージェリ（CSRF）

- CSRF はサーバー側の処理を悪用し、XSS はブラウザ上で不正な処理が実行される事で攻撃が起きる

#### 脆弱性の原因

- form 要素の action 属性にはどのドメインの URL でも指定できる：罠サイトから本サイトにリクエストを送れる
- クッキーに保管されたセッション ID は、対象サイトに自動的に送信される：罠経由のリクエストにもクッキー値が送信される

#### 対策

- CSRF 対策の必要なページを区別する
- 正規利用者の意図したリクエストを確認できるように実装する
  - 秘密情報（token）の埋め込み
  - パスワード再入力
  - Referer のチェック

重要な処理実行後に、通知メールを送信することも CSRF 脆弱性への保険的対策になる。
（攻撃事態は防げずとも、不正な処理が行われたことが発覚し被害が拡大しにくくなる）

### クリックジャッキング

- 攻撃対象ページを罠ページで隠し、利用者が気づかないうちに攻撃対象サイトでのクリックを誘導する。

#### 対策

- X-Frame-Options ヘッダに DENY もしくは SAMEORIGIN を指定することで、iframe の参照を制限する

## 4.6 セッション管理の不備

### セッションハイジャック

ある利用者のセッション ID を悪用して成りすますこと

「推測」「盗み出し」「強制」など様々な方法でセッション ID が知られてしまう可能性があり、個別の対策が必要となる。

対策

- セッション管理機構を利用する

### URL 埋め込みのセッション ID

セッション ID を URL に埋め込むと、Referer ヘッダを経由して、セッション ID が外部に漏えいし、なりすましの原因になる場合がある。

#### 対策

- クッキーにセッション ID を保存する

### セッション ID の固定化

セッション ID を外部から強制することで、セッションハイジャックを引き起こす

#### 対策

- 認証後にセッション ID を変更する
- セッション ID の変更ができない場合、トークンを使用する
- 認証前はセッション変数に秘密情報を保存しない

※これらの対策は適用箇所も少ないため、設計段階から計画的に対策することが推奨される

## 4.7 リダイレクト処理にまつわる脆弱性

### オープンリダイレクト

任意のドメインにリダイレクトできる脆弱性。利用者が知らないうちに別ドメインに遷移すると、フィッシング詐欺に悪用される場合がある。
※フィッシング：著名な Web サイトを模した偽サイトに誘導し、個人情報などを入力させる手口

#### 対策

下記のいずれかを実施する

- リダイレクト先の URL を湖底にする
- リダイレクト先の URL を直接指定せず番号指定にする
- リダイレクト先のドメイン名をチェックする

#### クッションページ

SNS など、利用者が URL を書き込むとリンクが生成されるサイトでは、フィッシングサイトへの誘導に使われるのを防ぐためにクッションページを挟むことがある。

### HTTP ヘッダ・インジェクション

リダイレクトやクッキー発行など、外部からのパラメータを元に HTTP レスポンスヘッダを出力する際に発生する。レスポンスヘッダの出力時に改行を挿入されることで、レスポンスヘッダの追加やレスポンスボディの偽造が行われる。

#### 脆弱性の原因

HTTP レスポンスヘッダは改行で区切られて定義されている。URL やクッキー値として設定されるパラメータ中に改行を挿入すると、それがレスポンスとして出力される事が脆弱性の原因。

#### 対策

- 外部からのパラメータを HTTP レスポンスヘッダとして出力しない

上記が最も確実な対策。どうしても外部からのパラメータを HTTP レスポンスヘッダとして出力しなければならない場合は、次の対策を実施する。

- リダイレクトやクッキー生成を専用 API に任せる
- ヘッダ生成するパラメータの改行文字をチェックする

## 4.8 クッキー出力にまつわる脆弱性

クッキーにまつわる脆弱性は大別すると２種類

- クッキーを利用すべきでない目的でクッキーを使っている
- クッキーの出力方法に問題がある

### クッキーの不適切な利用

#### クッキーに保存すべきでない情報

クッキー値はアプリケーションの利用者によって書き換えが可能なため、書き換えられると困る情報をクッキーに保存すると脆弱性の原因となる。  
例）ユーザー ID、権限情報

### クッキーのセキュア属性不備

セキュア属性のないクッキーは平文で送信される場合があり、盗聴される可能性がある。

#### 脆弱性の原因

- 開発者がセキュア属性について知らない
- セキュア属性を付けるとアプリケーションが動かなくなる  
  決済段階に入ってから HTTPS ページに移動するなど、HTTP と HTTPS が混在する Web アプリの場合、セッション ID を保持するクッキーにセキュア属性を付与することは困難。（HTTP のページでセッション ID のクッキーが受け取れなくなるため）  
  【シンプルな解決策】サイト全体を HTTPS にしたうえでクッキーにセキュア属性を付ける（常時 TLS）

#### 対策

- トークンを用いた対策

セッション ID を保持するクッキーにセキュア属性が付けられない場合、トークンを保持するクッキーにセキュア属性を付けることで HTTP と HTPPS でのセッションを共有しつつ、セッションハイジャックを防ぐ。

トークンはサーバーとブラウザの双方向で確実に暗号化され、HTTPS のページ閲覧にはトークンが必要であることから安全性が確保される。

#### セキュア属性以外の属性値に関する注意

- Domain 属性：デフォルトが最も安全
- Path 属性：ディレクトリ毎に異なるセッション ID を発行する場合には Path 属性を指定する。指定しても安全性が高まるわけではない。
- Expires 属性：通常は Expires 属性を付けずブラウザ終了時に Cookie が削除される状態にする。Expires 属性を指定すると、ブラウザ終了後も認証状態を維持できる。
- HttpOnly 属性：HttpOnly 属性をつけたクッキーは JS から参照できなくなる。セッション ID は JS から参照する意味がないので通常付けるとよい。

## 4.9 メール送信の問題

- メールヘッダ・インジェクション脆弱性
- hidden パラメータによる宛先保持
- メールサーバーによる第三者中継

がメール送信の問題として知られる。

### メールヘッダ・インジェクション脆弱性

メールメッセージの宛先や件名などヘッダーフィールドに改行を挿入することで、新たなフィールドを追加したり本文を改竄する攻撃を許す脆弱性

### hidden パラメータによる宛先保持

メールの送信先を hidden パラメータで指定するフォームでは、送信先アドレスを任意のアドレスに変更することで迷惑メールの送信に悪用される可能性がある。

### メールサーバーによる第三者中継

メールサーバーの設定に問題があると、第三者のメールを中継する場合があり、迷惑メール送信に悪用される可能性がある。

### 脆弱性が生まれる原因

メールのメッセージ形式はヘッダとボディを空行で区切る形式。そのため、外部から指定するパラメータに改行を挿入できれば新たなヘッダを追加できる。

### 対策

- メール送信には専用のライブラリを使用する。  
  sendmail コマンドを使用することが脆弱性が入りやすい原因となる。

その上で、以下のいずれかを実施する事が推奨される。

- 外部からのパラメータをメールヘッダに含ませないようにする
- 外部からのパラメータには改行を含まないようにメール送信時にチェックする

#### 外部からのパラメータをメールヘッダに含ませないようにする

From ヘッダを固定にするなど、外部からのパラメータをメールヘッダに含ませないようにする。

#### 外部からのパラメータには改行を含まないようにメール送信時にチェックする

メール送信用のラッパー関数を作成し、関数側で改行文字をチェックする。フレームワークの提供するメール送信機能に改行チェックを組み込む。などが有効な対策となる。

## ファイルアクセスにまつわる問題

### ディレクトリ・トラバーサル

外部からパラメータの形でファイル名を指定できる Web アプリでは、ファイル名に対するチェックが不十分だと意図しないファイルに対して閲覧、改ざん、削除ができる場合がある。この脆弱性をディレクトリ・トラバーサル脆弱性と呼ぶ。

- 秘密情報の漏えい、データの改ざん・削除、任意のスクリプトの実行、アプリケーションの機能停止

#### 脆弱性が生まれる原因

ディレクトリ・トラバーサル脆弱性の発生条件は以下の 3 つ

- ファイル名を外部から指定することができる
- ファイル名として、絶対パスや相対パスの形で異なるディレクトリを指定できる
- 組み立てたファイル名に対するアクセスの可否をチェックしていない

3 条件のいずれかをなくせば、脆弱性は解消される

#### 対策

**外部からファイル名を指定できる仕様を避ける**

- ファイル名を固定にする
- ファイル名をセッション変数に保持する
- ファイル名を直接指定するのではなく番号などで間接的に指定する

などで対策可能

**ファイル名にディレクトリ名が含まれないようにする**  
ファイル名にディレクトリ名が含まれないようになれば、アプリケーションの想定したディレクトリのみにアクセスすることになり、脆弱性の余地がなくなる

また、ディレクトリを指名す記号文字は OS により異なるため、OS の違いを考慮したライブラリを使用するべき

**ファイル名を英数字に限定する**
ファイル名の文字種の仕様を英数字に限定すれば、記号文字が使えなくなるのでディレクトリ・トラバーサル対策となる。

### 意図しないファイル公開

公開ディレクトリ内に閲覧されると困るファイルを配置していると、URL がばれた場合に秘密ファイルの閲覧が可能になる。

#### 脆弱性の原因

- ファイルが公開ディレクトリに置かれている
- ファイルに対する URL を知る手段がある
  - ディレクトリ・リスティングが有効
  - ファイル名が日付やユーザ名、連番など類推可能
  - user.dat, data.txt などありがちな名前
  - エラーメッセージや、他の脆弱性によりファイルのパス名が分かる
  - 外部サイトからリンクされるなどして検索エンジンに登録される
- ファイルに対するアクセス制限がかかっていない

#### 対策

非公開ファイルを公開ディレクトリに置かないことが根本的対策。そのために以下が推奨される。

- アプリケーション設計時に、ファイルの安全な格納場所を決める
- レンタルサーバーを契約する際は、日公開ディレクトリが利用できることを確認する

## OS コマンド呼び出しの際に発生する脆弱性

### OS コマンド・インジェクション

Web アプリ開発に用いる言語の多くはシェル経由で OS コマンドを呼び出す機能を提供しており、その機能の使い方に問題があると意図しない OS コマンドが実行可能になる場合がある。これを OS コマンド・インジェクション脆弱性と呼ぶ。

【典型的な攻撃シナリオ】

1. 攻撃用ツールを外部からダウンロード
2. ダウンロードしたツールに実行権限を与える
3. OS の脆弱性を内部から攻撃して管理者権限を得る
4. Web サーバーが攻撃者の思いのままになる

#### 脆弱性が生まれる原因

- シェルを呼び出す機能のある関数（system, open など）を利用している
- シェル呼び出しの機能のある関数にパラメータを渡している
- パラメータ内に含まれるシェルのメタ文字をエスケープしていない  
  `&` や `|` などのメタ文字をエスケープしていない場合、複数のコマンドを実行することが可能となり、開発者の意図と異なる OS コマンドが実行可能となる。

上記 3 つをすべて満たす場合に OS コマンド・インジェクション脆弱性が生まれる。

#### 対策

- OS コマンド呼び出しを使わない実装方法を選択する
- シェル呼び出し機能のある関数の利用を避ける
- 外部から入力された文字列をコマンドラインのパラメータに渡さない
- OS コマンドに渡すパラメータを安全な関数によりエスケープする

上記の対策は優先度順に並べている。

## ファイルアップロードにまつわる問題

アップローダに対する攻撃

- アップロード機能に対する DoS 攻撃  
  アップロード機能に対して大量のデータを送信することで Web サイトに過大な負荷をかける DoS 攻撃を仕掛けられる可能性がある。  
  対策：アップロードファイルの容量制限
- アップロードされたファイルをサーバー上のスクリプトとして実行する攻撃  
  利用者がアップロードしたファイルが Web サーバー上の公開ディレクトリに保存される場合、外部からアップしたスクリプトファイルが Web サーバー上で実行できる可能性がある。
- 仕掛けを含むファイルを利用者にダウンロードさせる攻撃  
  仕掛けを含むファイルを攻撃者がアップし、利用者がそのファイルを閲覧すると利用者の PC 上でスクリプトの実行やマルウェア感染などが発生する
- 閲覧権限のないファイルのダウンロード  
  ファイルにアクセス権限がかかっていない場合、URL の推測により権限のない利用者がファイルをダウンロードできる可能性が発生する。

### アップロードファイルによるサーバー側スクリプト実行

利用者がアップロードしたファイルを Web サーバーの公開ディレクトリに保存する場合かつ、ファイル名の拡張子でサーバーで実行可能な拡張子が指定できる場合、アップロードしたファイルをスクリプトとして Web サーバー上で実行できるようになる。

#### 脆弱性が生まれる原因

- アップロードしたファイルが公開ディレクトリに保存される
- アップロード後のファイル名として「.php」「.asp」「.aspx」「.jsp」などサーバースクリプトを示す拡張子が指定できる

上記 2 点に該当するアプリケーションを作ると、脆弱性の生まれる原因となる。少なくともいずれかに該当しないようにすることが対策となる。

アップロードファイルを公開ディレクトリに保存せず、スクリプト経由でダウンロードする「ダウンロードスクリプト」を利用することが対策となる。

### ファイルダウンロードによるクロスサイト・スクリプティング

アップロードしたファイルを利用者がダウンロードする際、ブラウザがファイルタイプを誤認すると PDF 中の JavaScript が実行されるような場合がある。
攻撃者が意図的にこれを仕向けると XSS 攻撃が成立する。

#### 脆弱性が生まれる原因

Content-Type の指定が間違っていると、ブラウザがコンテンツを HTML と解釈しコンテンツ中の JS が実行される可能性がある。また、ブラウザが扱えない Content-Type の場合も XSS になる場合がある。

#### 対策

**ファイルアップロード時**

- 拡張子が許可されたものかをチェックする

**ファイルダウンロード時**

- Content-Type を正しく設定する（必須）
- レスポンスヘッダ X-Content-Type-Options: nosniff を指定する（必須）
- 必要に応じて Content-Disposition ヘッダを設定する

### PDF の FormCalc によるコンテンツハイジャック

PDF で使用できる FormCalc というスクリプト言語で、FormCalc の URL 関数を用いた仕掛けを組み込んだ PDF ファイルをアップロードすることで、正規ユーザに成りすましを行う攻撃手法が考案されている。
対象ブラウザは主に IE。

#### 脆弱性が生まれる原因

Adobe Acrobat Reader のセキュリティ上好ましくない仕様が悪用される事。ただし、Adobe Reader の仕様が見直されるまあでは Web アプリ側で対応をとらざるを得ない。

#### 対策

下記の両方を実施して対策する。

- PDF ファイルはブラウザ内で開かずダウンロードを強制する
  `X-Download-Options: noopen` をレスポンスヘッダに指定することで、IE のダウンロードダイアログで「ファイルを開く」ボタンが表示されなくなる。
- PDF を object 要素や embed 要素では開けない仕組みを実装する
  ファイルダウンロードを POST のみに限定することで、PDF ファイルがロードされないようになる。

## 4.13 インクルードにまつわる問題

### ファイルインクルード攻撃

include などに指定するファイル名を外部から指定できる場合、意図しないファイルを指定することにより脆弱となる場合がある。
情報漏洩、サイト改ざん、不正な機能実行、他サイトへの攻撃（踏み台）などの影響がある。

#### 脆弱性が生まれる原因

- インクルードファイル名を外部から指定できる
- インクルードすべきファイル名かの妥当性チェックをしていない

#### 対策

ディレクトリ・トラバーサル脆弱性と同様の考え方で脆弱性を解消する。

- 外部からファイル名を指定する仕様を避ける
- ファイル名を英数字に限定する
- RFI 設定を禁止していることを確認する（保険的対策）

## 4.14 構造化データの読み込みにまつわる問題

### eval インジェクション

eval：ソースコードを解釈実行し、各言語のソースコードをデータとして扱うことができる機能・関数
eval インジェクション攻撃：eval の利用法に問題があり、外部から送り込んだスクリプトを実行する攻撃

### 安全でないデシリアライゼーション

シリアライズ（データをバイト列に変換すること）されたデータが信頼できない場合に、デシリアライズ処理の際に意図しないオブジェクトがアプリ内に生成され任意のコードを実行される場合がある。

安全でないデータのシリアライズは危険なため、データの受け渡しの形式をシリアライズ形式でなく JSON 形式にするなどの方法で対策する

### XML 外部実態参照（XXE）

XML データを外部から受け取るプログラムでは、XML の機能により Web サーバー内のファイルを不正に読み取られる可能性がある。
