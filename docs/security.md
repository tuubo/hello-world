## 4.3 表示処理に伴う問題

### HTML エスケープ

- 通常要素：`<` と `&` を文字参照にする
- 属性値：属性値を `"` で囲み、`<` と `&` と `"` を文字参照にする

HTML エスケープが適切にできていない場合、攻撃者が好きな属性や HTML 要素をコード上に追加し XSS 攻撃を仕掛ける事を許してしまう可能性がある。

- `src` などの属性値(URL)に javascript スキームを渡すと、 JavaScript を起動できる。

#### 対策

`http:` または `https:` で始まる絶対 URL、`/` で始まる相対 URL のどちらかのみを許容するようにチェックする。

## 4.4 SQL 呼び出しに伴う脆弱性

### SQL インジェクション

- SQL の呼び出し方に不備がある場合に発生する
- DB の情報漏えい、DB の書き換え、認証回避等の影響の大きい攻撃になりうる
- 静的プレースホルダを用いて SQL を呼び出すことで、SQL インジェクションを回避できる

## 4.5 「重要な処理」の際に混入する脆弱性

### クロスサイト・リクエストフォージェリ（CSRF）

- CSRF はサーバー側の処理を悪用し、XSS はブラウザ上で不正な処理が実行される事で攻撃が起きる

#### 脆弱性の原因

- form 要素の action 属性にはどのドメインの URL でも指定できる：罠サイトから本サイトにリクエストを送れる
- クッキーに保管されたセッション ID は、対象サイトに自動的に送信される：罠経由のリクエストにもクッキー値が送信される

#### 対策

- CSRF 対策の必要なページを区別する
- 正規利用者の意図したリクエストを確認できるように実装する
  - 秘密情報（token）の埋め込み
  - パスワード再入力
  - Referer のチェック

重要な処理実行後に、通知メールを送信することも CSRF 脆弱性への保険的対策になる。
（攻撃事態は防げずとも、不正な処理が行われたことが発覚し被害が拡大しにくくなる）

### クリックジャッキング

- 攻撃対象ページを罠ページで隠し、利用者が気づかないうちに攻撃対象サイトでのクリックを誘導する。

#### 対策

- X-Frame-Options ヘッダに DENY もしくは SAMEORIGIN を指定することで、iframe の参照を制限する

## 4.6 セッション管理の不備

### セッションハイジャック

ある利用者のセッション ID を悪用して成りすますこと

「推測」「盗み出し」「強制」など様々な方法でセッション ID が知られてしまう可能性があり、個別の対策が必要となる。

対策

- セッション管理機構を利用する

### URL 埋め込みのセッション ID

セッション ID を URL に埋め込むと、Referer ヘッダを経由して、セッション ID が外部に漏えいし、なりすましの原因になる場合がある。

#### 対策

- クッキーにセッション ID を保存する

### セッション ID の固定化

セッション ID を外部から強制することで、セッションハイジャックを引き起こす

#### 対策

- 認証後にセッション ID を変更する
- セッション ID の変更ができない場合、トークンを使用する
- 認証前はセッション変数に秘密情報を保存しない

※これらの対策は適用箇所も少ないため、設計段階から計画的に対策することが推奨される

## 4.7 リダイレクト処理にまつわる脆弱性

### オープンリダイレクト

任意のドメインにリダイレクトできる脆弱性。利用者が知らないうちに別ドメインに遷移すると、フィッシング詐欺に悪用される場合がある。
※フィッシング：著名な Web サイトを模した偽サイトに誘導し、個人情報などを入力させる手口

#### 対策

下記のいずれかを実施する

- リダイレクト先の URL を湖底にする
- リダイレクト先の URL を直接指定せず番号指定にする
- リダイレクト先のドメイン名をチェックする

#### クッションページ

SNS など、利用者が URL を書き込むとリンクが生成されるサイトでは、フィッシングサイトへの誘導に使われるのを防ぐためにクッションページを挟むことがある。

### HTTP ヘッダ・インジェクション

リダイレクトやクッキー発行など、外部からのパラメータを元に HTTP レスポンスヘッダを出力する際に発生する。レスポンスヘッダの出力時に改行を挿入されることで、レスポンスヘッダの追加やレスポンスボディの偽造が行われる。

#### 脆弱性の原因

HTTP レスポンスヘッダは改行で区切られて定義されている。URL やクッキー値として設定されるパラメータ中に改行を挿入すると、それがレスポンスとして出力される事が脆弱性の原因。

#### 対策

- 外部からのパラメータを HTTP レスポンスヘッダとして出力しない

上記が最も確実な対策。どうしても外部からのパラメータを HTTP レスポンスヘッダとして出力しなければならない場合は、次の対策を実施する。

- リダイレクトやクッキー生成を専用 API に任せる
- ヘッダ生成するパラメータの改行文字をチェックする

## 4.8 クッキー出力にまつわる脆弱性

クッキーにまつわる脆弱性は大別すると２種類

- クッキーを利用すべきでない目的でクッキーを使っている
- クッキーの出力方法に問題がある

### クッキーの不適切な利用

#### クッキーに保存すべきでない情報

クッキー値はアプリケーションの利用者によって書き換えが可能なため、書き換えられると困る情報をクッキーに保存すると脆弱性の原因となる。  
例）ユーザー ID、権限情報

### クッキーのセキュア属性不備
セキュア属性のないクッキーは平文で送信される場合があり、盗聴される可能性がある。

